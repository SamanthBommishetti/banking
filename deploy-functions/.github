name: Deploy All Azure Functions (Day 4 + Day 5)

on:
  push:
    branches:
      - main
    paths:
      - "DetectFraud/**"
      - "EventGridTrigger/**"
      - "QueueProcessor/**"
      - "Sync_Customers_Daily/**"
      - "Update_Account_Status_Daily/**"
      - "requirements.txt"
      - "host.json"
      - "local.settings.json"

jobs:
  deploy-functions:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Azure Functions Core Tools
        run: npm install -g azure-functions-core-tools@4 --unsafe-perm true

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy DetectFraud (Event Grid Trigger)
        if: success()
        run: |
          cd DetectFraud
          func azure functionapp publish samfuncapp --no-build

      - name: Deploy Sync_Customers_Daily (Timer)
        if: success()
        run: |
          cd Sync_Customers_Daily
          func azure functionapp publish samfuncapp --no-build

      - name: Deploy Update_Account_Status_Daily (Timer)
        if: success()
        run: |
          cd Update_Account_Status_Daily
          func azure functionapp publish samfuncapp --no-build

      - name: Deploy QueueProcessor (Service Bus Trigger)
        if: success()
        run: |
          cd QueueProcessor
          func azure functionapp publish charitha-servicebus-func --no-build

      - name: Deploy Fraud Alert Processor
        if: success()
        run: |
          cd EventGridTrigger
          func azure functionapp publish charitha-fraudalert-func --no-build

      - name: Success Notification
        if: success()
        run: |
          echo "ALL FUNCTIONS DEPLOYED SUCCESSFULLY!"
          echo "Real-time fraud detection is LIVE"

      - name: Failure Notification
        if: failure()
        run: echo "DEPLOYMENT FAILED â€” CHECK LOGS!"
